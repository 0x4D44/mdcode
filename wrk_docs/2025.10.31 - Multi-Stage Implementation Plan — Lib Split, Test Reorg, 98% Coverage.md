# Multi‑Stage Implementation Plan — Lib Split, Test Reorg, 98% Coverage

Date: 2025-10-31
Owner: md
Repo: mdcode (Rust crate/CLI)

## Objectives
- Achieve LLVM line coverage ≥98% and Tarpaulin ≥95% without changing CLI behavior.
- Separate production logic into a library (`src/lib.rs`), keep `src/main.rs` minimal.
- Move tests to `tests/` to avoid test lines in library coverage denominator.
- Scope coverage tooling to library with `cargo llvm-cov --lib`.

## Guardrails (applies to all stages)
- Behavioral parity: copy implementations verbatim; do not change messages or signatures unless noted.
- No new hard dependencies. If needed, feature-gate and default off.
- Keep tests offline; use `tempfile` and local bare remotes; no network.
- Pre-flight for each PR: `cargo fmt --all` • `cargo clippy -- -D warnings` • `cargo test` • `make coverage`.
- Rollback: revert the PR; no data migrations.

---

## Stage A — Prepare and Stabilize (PR 1)
- Goals
  - Establish cfg/lint guard for `cfg(tarpaulin)` to silence warnings.
  - Add developer coverage helper for lib-only export.
- Tasks
  - In `Cargo.toml` add:
    ```toml
    [lints.rust]
    unexpected_cfgs = { level = "warn", check-cfg = ["cfg(tarpaulin)"] }
    ```
  - Update `Makefile`:
    - `coverage-llvm`: `cargo llvm-cov --lib --summary-only --json --output-path target/coverage/llvm-summary.json`
    - Add `coverage-detailed`: `cargo llvm-cov --lib --json --output-path target/coverage/llvm-detailed.json`
- Acceptance
  - `cargo build` and `cargo test` succeed.
  - `make coverage` succeeds and produces LLVM summary with `--lib`.
- Risks/rollback
  - Low; config-only changes. Revert file edits if needed.

## Stage B — Extract Library (verbatim) (PR 2)
- Goals
  - Create `src/lib.rs` and move production code without semantic changes.
- Tasks
  - Copy production fns from `src/main.rs` into `src/lib.rs` verbatim.
  - Mark items `pub` only as required by tests/CLI (exact names kept):
    - Entry: `Cli`, `Commands`, `execute_cli`, `run`.
    - Repo: `new_repository`, `update_repository`, `info_repository`, `scan_*`, `detect_file_type`, `.gitignore` helpers, `is_dirty`.
    - Diff: `diff_command`, `checkout_tree_to_dir`, `create_temp_dir`, `launch_*`.
    - GH: `gh_cli_path` (no new deps), `gh_create_via_cli`, `gh_create_api` (stub), `add_remote`, `gh_push`, `gh_fetch`, `gh_sync`, `remote_branch_exists`.
    - Tag: `normalize_semver_tag`, `read_version_from_cargo_toml`, `tag_release`.
  - Keep `ensure_test_logger()` behind `#[cfg(test)]` in lib.
- Verification
  - Temporarily keep tests in `src/main.rs` to confirm parity.
  - `cargo test` stays green.
- Acceptance
  - No behavior change; all existing tests pass.
- Risks/rollback
  - If compilation or tests fail, adjust visibility only; avoid logic edits. Revert PR if needed.

## Stage C — Thin Binary Wrapper (PR 3)
- Goals
  - Reduce `src/main.rs` to logging + `mdcode::run()`.
- Tasks
  - Keep env_logger format and error printing identical.
  - Preserve `#[cfg(tarpaulin)] fn main(){}` if used.
- Acceptance
  - `cargo test` and `make coverage` green.
- Risks/rollback
  - Very low. Revert or restore wrapper if needed.

## Stage D — Move Tests to `tests/` (PR 4)
- Goals
  - Relocate all `#[cfg(test)]` modules from `src/main.rs` into integration tests without changing test intent.
- Tasks
  - Create `tests/` files grouped by domain: `detect.rs`, `repo.rs`, `diff.rs`, `gh.rs`, `tag.rs`.
  - Replace `use super::*;` with `use mdcode::*;`.
  - Add per-file imports: `use git2::Repository; use std::path::Path;`.
  - Guard Unix-only tests with `#[cfg(unix)]`.
  - Keep environment guards from original tests (e.g., `MDCODE_DIFF_TOOL`).
- Verification
  - `cargo test` passes.
  - `make coverage` runs; expect LLVM to increase due to lib-only scope, and Tarpaulin to remain ≥ baseline.
- Acceptance
  - No test intent change; parity proven.
- Risks/rollback
  - If migration is noisy, move tests incrementally (per file) over multiple commits.

## Stage E — Targeted Coverage Tests (PR 5)
- Goals
  - Close gaps identified in the design review for ≥98% LLVM lines.
- Tasks (new tests)
  - `diff_command(..)`: invalid index parse; index out of range; H/L length mismatch; dry-run summary; timestamp error path (simulate unexpected commit time via safe stub if feasible or validate error branch by injecting invalid input conditions).
  - `launch_diff_tool(..)`: env override success (`true` on Unix); CLI failure path; fallback when `git difftool` missing.
  - `info_repository(..)`: not-a-repo error; empty repo; 1 commit; ≥20 commits prints list.
  - `is_dirty(..)`: staged new/deleted/typechange; EOL-only unchanged; path-not-in-HEAD considered dirty.
  - Minor edges: `read_version_from_cargo_toml` missing `[package]`/`version`; `gh_cli_path` PATH probing; `remote_branch_exists` true/false.
- Verification
  - `cargo test` and `make coverage` show LLVM ≥98%, Tarpaulin ≥95%.
- Acceptance
  - Coverage thresholds met locally.
- Risks/rollback
  - If specific branches are hard to simulate, add small internal seams via cfg(test) helpers (kept private) rather than logic rewrites.

## Stage F — CI and Documentation (PR 6)
- Goals
  - Enforce and document coverage.
- Tasks
  - Add LLVM fail-under to CI (post‑success): `cargo llvm-cov --lib --fail-under-lines=98`.
  - Keep Python `coverage_gate.py` as regression guard based on `coverage_baseline.toml`.
  - Update readme.md with coverage commands and thresholds.
- Acceptance
  - CI fails on coverage regression; docs show up-to-date usage.

## Optional Stage G — GH Backend Abstraction (PR 7; deferred)
- Goals
  - Make GH integration swappable for deterministic tests (nice-to-have).
- Tasks
  - Define `GhBackend` trait and implement a `StubBackend` (no network) and `GhCliBackend`.
  - Wire CLI to select backend; leave library synchronous.
- Acceptance
  - Tests unaffected; still offline; behavior unchanged.

---

## Work Breakdown & Sequencing
- PR 1 (A): Config + Makefile updates (small, quick win).
- PR 2 (B): Introduce lib with verbatim code; visibility only.
- PR 3 (C): Thin main.
- PR 4 (D): Move tests to `tests/` (may split into D1–D3 by domain to ease review).
- PR 5 (E): Targeted tests to push to thresholds.
- PR 6 (F): CI gate + docs.
- PR 7 (G): Optional abstraction (post‑coverage).

## Validation Checklist (each PR)
- Format: `cargo fmt --all`
- Lint: `cargo clippy -- -D warnings`
- Unit/Integration: `cargo test`
- Coverage snapshot: `make coverage` (Tarpaulin + LLVM lib-only)
- Manual smoke: run a few CLI commands on a temp repo (new/update/info/diff/tag).

## Metrics & Exit Criteria
- LLVM lines ≥98% (lib-only) and Tarpaulin ≥95%.
- No regressions in functional tests or CLI behavior.
- CI coverage gate enabled and passing.

## Risks & Mitigations (summary)
- Behavior drift during move → verbatim copy; parity tests.
- Platform variance → guard Unix-only tests; CRLF normalization preserved.
- Flaky Git operations → local bare remotes; explicit flags on pulls/merges.
- Coverage measurement confusion → `--lib` enforced in Makefile and CI.

