# Coverage Improvement Plan — mdcode
Date: 2025-10-30
Target: ≥98.0% line coverage (LLVM), ≥95% (Tarpaulin)

## Stage 1 — Refactor for Clean Measurement
- Create `src/lib.rs`; move production functions out of `src/main.rs`.
- Keep `src/main.rs` as thin CLI wrapper parsing args and calling library.
- Preserve current behavior/CLI; no functional changes.

Deliverables:
- Library exposes public API: `execute_cli`, `new_repository`, `update_repository`, `info_repository`, `diff_command`, `tag_release`, `gh_*`, helpers.

## Stage 2 — Test Suite Reorganization
- Move inline unit tests from `src/main.rs` to `tests/` as integration tests that exercise the library API and binary behavior where appropriate.
- Reuse existing fixtures (temp git repos); avoid network.
- Keep test names and coverage intent; split into logical files (e.g., `tests/tag.rs`, `tests/diff.rs`, `tests/gh.rs`, `tests/repo.rs`).

Deliverables:
- Tests pass via `cargo test`.
- `cargo llvm-cov --json` shows only library files in coverage report (not test sources).

## Stage 3 — Close Coverage Gaps (Targeted Cases)
- `diff_command(..)`: cover invalid indices, H/L modes, mismatched argument counts, and dry-run formatting.
- `launch_diff_tool(..)`: cover env override, `git difftool` missing/failure, and fallback messaging.
- `info_repository(..)`: cover empty repo, <20 commits, >=20 commits list, and error handling (no repo).
- `is_dirty(..)`: cover staged-only changes, EOL normalization, renames/typechange, and confirm untracked-only path.
- Minor edges: `read_version_from_cargo_toml` no `[package]`/no `version`, `gh_cli_path` PATH probing failure.

Deliverables:
- LLVM ≥ 98% line coverage.

## Stage 4 — Automation & Guardrails
- Extend `Makefile` with `coverage-detailed` target for local triage of missing lines.
- Add `cargo llvm-cov --fail-under-lines=98` to CI (if present) after refactor.
- Keep existing `scripts/coverage_gate.py` for regression control.

## Rollback Plan
- Changes are isolated to file moves and test locations; revert by restoring `src/main.rs` monolith and inline tests.

## Timeline
- Stages 1–3 executed in this PR.

