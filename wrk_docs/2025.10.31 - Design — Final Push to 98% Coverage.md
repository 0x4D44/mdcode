# Design — Final Push to 98% Coverage

Date: 2025-10-31
Author: Coverage/Gating Track

## Objective
Raise LLVM line coverage for the `mdcode` library to ≥98% without changing runtime behavior, by:
- Adding minimal, deterministic integration tests that execute specific branches left uncovered.
- Avoiding flaky or platform-specific behavior in tests (prefer PATH shims and offline features).

## Constraints & Principles
- Do not alter public behavior or CLI semantics.
- Keep coverage-driven compactions limited to `#[cfg(coverage)]` paths for display-only logic.
- Keep tests offline and hermetic (no real GitHub API calls).

## Targeted Gaps and Solutions
1. execute_cli GhCreate — Internal visibility flag
   - Gap: Branch that sets `selected = Some(RepoVisibility::Internal)` was counted but not executed.
   - Solution: Add an integration test invoking `execute_cli` with `gh_create --internal` and a PATH shim for `gh` to succeed.

2. gh_cli_path success return
   - Gap: Success path returning `Some(PathBuf::from("gh"))` after `gh --version` was unexecuted.
   - Solution: Add a test that prepends a shim `gh` which exits 0 for `--version`.

## Test Design
- Both tests use a small POSIX shell shim placed at the front of PATH. This keeps them deterministic and fast.
- Tests are marked `#[cfg(unix)]` implicitly via shell usage; they don’t run on Windows CI.
- No network calls; the `offline_gh` feature is enabled for coverage runs via Makefile.

## Alternatives Considered
- Mocking `Command` via indirection. Rejected to avoid invasive refactors.
- Moving more logic behind `#[cfg(coverage)]`. Avoided except for print-only paths already agreed in prior design.

## Risk Assessment
- Low risk: tests-only change. The PATH shim pattern is already used elsewhere in the suite.
- Windows coverage remains limited to non-CLI fallbacks; acceptable for this target.

## Acceptance Criteria
- `make coverage-detailed` reports ≥98.0% line coverage (LLVM) with all tests passing.

