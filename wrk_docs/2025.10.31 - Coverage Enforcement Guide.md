Coverage Enforcement Guide

Date: 2025-10-31

Overview
- This document explains how coverage is measured, enforced, and maintained locally and in CI for the `mdcode` crate.

Measurement
- Tooling: `cargo llvm-cov` (LLVM source-based coverage). Optional: `cargo tarpaulin` for trend tracking.
- Library-only coverage: `src/main.rs` is excluded; integration tests are included.
- Feature flags: `--features offline_gh` avoids networked GitHub API paths during tests.
- Outputs:
  - `target/coverage/llvm-summary.json` — summary (lines/functions/regions).
  - `target/coverage/llvm-detailed.json` — detailed line/region mapping.
  - `target/coverage/html/` — interactive HTML report.
  - `target/coverage/lcov.info` — LCOV for external tools.

Enforcement
- CI gate: `make coverage-llvm-gate-98` fails if LLVM line coverage < 98%.
- Local guard: `scripts/coverage_gate.py` compares against `coverage_baseline.toml` and rejects regressions > `threshold.max_drop`.
- Developer preflight: `make preflight` runs fmt, clippy (code + tests), tests, then a 97% LLVM gate to speed iteration.

Baselines
- File: `coverage_baseline.toml`
  - `baseline.llvm_line = 98.47` (current steady-state)
  - `baseline.tarpaulin_line = 43.49` (trend only; optional in CI)
  - `threshold.max_drop = 5.0`

Maintainer Tips
- To update the baseline after legitimate improvements:
  1. Run `make coverage-llvm` and verify improvements are stable across two runs.
  2. Edit `coverage_baseline.toml` and raise `baseline.llvm_line` conservatively (≤ current measured percent).
  3. Add a doc entry under `wrk_docs/` summarizing the new baseline and rationale.
- To investigate regressions quickly:
  - Run `make coverage-detailed` and inspect `target/coverage/llvm-detailed.json`.
  - Generate HTML: `make coverage-html && make coverage-open`.
  - Focus on top uncovered clusters; prefer small, targeted tests over broad ones.

CI Artifacts
- Uploaded by workflow: JSON summary, HTML report, LCOV file.
- Retention: 5 days (see `.github/workflows/ci.yml`). Adjust as needed.

References
- Final snapshot: `wrk_docs/2025.10.31 - CR - Final Coverage Snapshot.md` (98.4668% lines).
- Baseline update: `wrk_docs/2025.10.31 - CR - Coverage Baseline Update.md`.
