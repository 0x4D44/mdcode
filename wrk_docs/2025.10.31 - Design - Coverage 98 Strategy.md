# Design — Coverage 98% Strategy (mdcode)

Date: 2025-10-31

Goal: Raise line coverage to ≥98% while keeping behavior correct and tests fast/offline.

Scope
- Crate: `mdcode` (library + thin binary)
- Targets: Linux and Windows; CI defaults to Linux.
- Tools: `cargo tarpaulin`, `cargo llvm-cov` (Make targets already present).

Key Constraints
- Tests must not require network or real GitHub tokens.
- Don’t break CLI UX; keep flows intact.
- Keep logs concise; prefer `RUST_LOG` gating.

Architecture Notes (current)
- CLI parsed in `src/lib.rs::Cli` with subcommands new/update/info/diff/gh_* /tag.
- Git operations via `git2` + some `git` CLI invocations for tagging/push.
- GH integration prefers CLI (`gh`), falls back to Octocrab API.
- Diff tool launcher is Windows‑centric (WinMergeU/windiff) with best-effort errors elsewhere.

Coverage Strategy
1) High‑value tests
   - GhCreate via CLI: conflicts, dot‑dir name resolution, non‑zero exit.
   - Diff invalid arg modes, H/L combinations, and dual‑failure diff tool.
   - Info listing with ≥20 commits to exercise index formatting.
   - Tagging: force overwrite error, push paths (success/failure), allow_dirty guard.
   - Resolve signature precedence and add additional branches for repo/global config fallbacks.

2) Testability seams (no network)
   - Prefer PATH shims for `gh` and `git` behaviors over API.
   - Add an optional test feature `offline_gh` to stub `gh_create_api()` (future step).

3) Platform specifics
   - Guard Unix‑only assertions with `#[cfg(unix)]` and Windows code with `#[cfg(windows)]` where applicable.
   - For non‑Windows CI, keep diff tool paths covered via direct error tests.

4) Coverage tuning (measurement)
   - Keep Makefile targets; add an optional `coverage-llvm-lib` using `--lib` for library‑only gating.
   - Remove duplicate, unused library `main()` to avoid dead lines dragging coverage.

5) CI gating (later stage)
   - Add `llvm-cov --fail-under-lines=98` job once local coverage stabilizes ≥98%.

Test Plan (phased)
P1 (fast wins)
- GhCreate CLI shim tests (conflicts, dot, non‑zero) — DONE
- Diff invalid modes + tool dual failure — DONE
- Info ≥20 commits loop — DONE
- Remove lib `main()` duplication — DONE

P2 (branches)
- Tag overwrite error and success with `--force`/`--no-push`.
- gh_push: missing remote and merge conflict messages.
- read_version_from_cargo_toml: missing file and malformed toml.
- is_dirty: rename/typechange branches.

P3 (polish + gates)
- Optional `offline_gh` feature for API path stubbing and targeted tests.
- Add `coverage-llvm-lib` and CI fail‑under gate.

Risks
- Global process state in tests (PATH/cwd) → use `serial_test` where needed.
- Git timing/ordering flakiness → use local repos and deterministic commits.

Rollout
- Land P1 tests, validate coverage bump.
- Iterate through P2 until ≥98%, then enable CI gate.

