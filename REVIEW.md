# Code Review Report

## Findings
- **High – `.gitignore` and other dotfiles never staged** (`src/main.rs:950`, `src/main.rs:1038`, `src/main.rs:1166`, `src/main.rs:1524`, `src/main.rs:1698`): `new` builds the file list before writing `.gitignore`, and `update` only stages paths that `detect_file_type` recognises. Dotfiles (no extension) are filtered out, so `.gitignore` is left uncommitted and later edits to tracked dotfiles are silently skipped. This breaks the default workflow and risks shipping outdated ignore rules. Stage `.gitignore` explicitly when it is created and fall back to staging tracked-but-unmatched files (e.g. `git add -u`) so metadata stays in sync.
- **High – `gh_create` API fallback ignores visibility flags** (`src/main.rs:283`, `src/main.rs:314`, `src/main.rs:1775`): When the GitHub CLI is missing, `gh_create` falls back to `gh_create_api` but only sends `name`/`description`, silently dropping the selected visibility. Users asking for `--public` or `--internal` end up with whatever default GitHub chooses (usually private). Pass the visibility choice through to the API payload (set `private`, or `visibility`) so behaviour matches the CLI implementation.
- **High – Diff temp directories use raw paths and break on Windows** (`src/main.rs:1401`, `src/main.rs:1758`): `diff` embeds the target directory (e.g. `C:\repo`) inside the temp dir name. On Windows those colons/backslashes make the path invalid, so `create_temp_dir` fails. Normalise the prefix (e.g. replace path separators with `_`) before creating the directory.
- **Medium – Diff tooling is Windows-only** (`src/main.rs:1471`, `src/main.rs:1480`): `launch_diff_tool` only tries `WinMergeU.exe` and `windiff.exe`. On macOS/Linux every invocation logs an error and shows nothing. Add an OS-specific fallback (e.g. honour `$DIFF_TOOL`, fall back to `git diff`/`code --diff`) so the command works cross-platform.
- **Medium – Reported version lags crate version** (`src/main.rs:50`, `Cargo.toml:3`): Clap is hard-coded to `version = "1.9.1"` while the crate is `2.0.2`, so `mdcode --version` lies to users and tooling. Point Clap at the crate version (`env!`/`cargo` env var) to keep them aligned.
- **Medium – `tag --allow-dirty` flag is a no-op** (`src/main.rs:550`, `src/main.rs:562`): The parameter is intentionally ignored, yet the CLI help still advertises the guard. Either enforce the cleanliness check (unless `--allow-dirty`) or drop the flag and update the docs to avoid surprising release workflows.
- **Medium – `gh_push` guesses `master` on detached HEAD** (`src/main.rs:1959`): If HEAD is detached (or points to a differently named branch), the code falls back to pushing `master`, often failing or pushing the wrong branch. Detect this case and surface an explicit error instead of guessing.

## Additional Observations
- `update --dry-run` does not preview anything and still prompts for a commit message because staging is skipped entirely (`src/main.rs:1038`, `src/main.rs:1080`). Consider staging into a temporary index so users see what would change.
- `readme.md:46` opens a shell block that never closes, so everything down to “Configuration” renders as code. Close the block after the build instructions.
