# Journal — Coverage Refactor (Lib Split, Test Reorg, 98%)
Date: 2025-10-31
Author: md

## Entry 3 — Stage B: create lib + thin bin
- Copied src/main.rs to src/lib.rs and removed both main() functions.
- Replaced src/main.rs with thin wrapper calling mdcode::run().
- Fixed visibility: made lib::run() public.
- Next: run tests and coverage to confirm parity; then proceed to Stage D.

## Entry 4 — Stage D: move tests from lib to tests/
- Extracted #[cfg(test)] modules from src/lib.rs into tests/: tag.rs, detect.rs, repo_and_cli.rs.
- Replaced internal `use super::*;` with `use mdcode::*;`.
- Next: run tests & coverage; if issues arise, add per-file imports.

## Entry 5 — Fix test imports after move
- Added `use std::path::Path;` and `use std::fs::File;` to tests/detect.rs.
- Added `use std::path::Path; use git2::Repository;` to tests/repo_and_cli.rs and Path to tests/tag.rs.
- Made public many lib functions and types to satisfy integration tests.

## Entry 6 — Tests passing after move
- cargo test now passes with tests moved to integration suite.
- Next: run make coverage to assess LLVM % after removing test lines from lib.

## Entry 7 — Adjust llvm-cov invocation
- Observed llvm-cov --lib only ran unit tests; integration tests were ignored, yielding 0% report.
- Switched Makefile back to plain `cargo llvm-cov` (no --lib) to include integration tests while still reporting only crate files by default.

## Entry 8 — Stage E: add targeted tests
- Added tests/cli_dispatch.rs to exercise execute_cli and diff flows incl. H/L modes and custom tool.
- Added tests/gh_flows.rs for gh_push/fetch/sync and signature precedence.
- Added tests/tag_more.rs for tag read/push/dirty flags.
- Added tests/update_and_info_edges.rs for dry-run preview and info error cases.
## Entry 9 — Fix failing tests & visibility
- Made Cli fields public and added execute_cli() in lib API.
- Restored allow-dirty enforcement in tag_release.
- Adjusted info_repository error string expectations in tests.
## Entry 10 — More edge tests
- Added tests/more_edges.rs: gh_cli_path PATH shim, add_remote idempotency, detached HEAD push error, and get_remote_head_commit fallback.
